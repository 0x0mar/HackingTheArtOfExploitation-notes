#include <pcap.h>
#include "hacking.h"
#include "hacking-network.h"

#include <sys/socket.h>
#include <netinet/ip.h>
#include <netinet/tcp.h>
#include <stdio.h>
#include <stdlib.h>
//#include <arpa/inet.h>
//#include <sys/types.h>
//#include <netdb.h>




int createRaw (int proto);
unsigned short csum (unsigned short *buf,int nwords);

int main(int argc, char * argv[]) {

	
	//part nova
	int rs;
	unsigned char packetBuffer[7713];
	struct sockaddr_in sin;

	printf("argc= %d\n",argc);
	
	if (argc <= 1) {
		printf("Usage: %s ip_destination \n",argv[0]);
		exit(-1);
	}


	srand(time(0));

	
	bzero((char *)&sin, sizeof(sin));
	sin.sin_family  = AF_INET;
	sin.sin_port = htons(55000);
	sin.sin_addr.s_addr = inet_addr(argv[1]);
		
	unsigned short buffer_size = sizeof(struct ip) + sizeof(struct tcphdr);
	printf("Buffer size: %u\n", buffer_size);

	struct ip *IPheader = (struct ip *) packetBuffer;
	struct tcphdr *TCPheader = (struct tcphdr *) (packetBuffer + sizeof (struct ip));

	//omplint el ip header
	IPheader->ip_hl=5;
	IPheader->ip_v = 4;
	IPheader->ip_tos = 0;
	IPheader->ip_len = htons(buffer_size);
	IPheader->ip_id = htonl(54321);
	IPheader->ip_off = 0;
	IPheader->ip_ttl = 255;
	IPheader->ip_p = 6;
	IPheader->ip_sum = 0;
	IPheader->ip_src.s_addr = inet_addr("123.4.5.6");
	IPheader->ip_dst.s_addr = inet_addr(argv[1]);

	//omplint el tcp header
	TCPheader->source = htons(55000);
	TCPheader->dest = htons(55000);
	TCPheader->seq = rand();
	TCPheader->ack_seq = 0;
	TCPheader->doff = 0;
	TCPheader->syn = 1;
	TCPheader->window = htonl(65535);
	TCPheader->check = 0;
	TCPheader->urg_ptr = 0;

	//checsum
	IPheader->ip_sum = csum((unsigned short *)packetBuffer, IPheader->ip_len >> 1);
	printf("IP checksum: %u \n",IPheader->ip_len);

	rs = createRaw( IPPROTO_TCP);
	printf(" the socket descriptor is %u\n",rs);
	int sendErr = sendto(rs,packetBuffer, sizeof(packetBuffer),0,(struct sockaddr *)&sin, sizeof(sin));

	printf(" after sending %u\n",sendErr);

	if (sendErr < sizeof(packetBuffer)){
		printf("Error sending packet, only sent %u\n",sendErr);
	} else {

		printf("Succesfully sent %u\n",sendErr);
	}	

	
}

	
int createRaw (int proto){

	int rs = socket(PF_INET, SOCK_RAW, proto);
	if (rs <0 ){
		perror("raw socket error\n");
		exit(-1);
	}else {
		printf(" raw socket created successfully!\n");
		return rs;
	}

	
}

unsigned short csum (unsigned short *buf,int nwords){

	unsigned long sum;
	for (sum = 0; nwords > 0 ; nwords--){sum += *buf++;}
	sum = (sum >> 16) + (sum & 0xffff);
	sum += (sum >> 16);
	return (unsigned short) (~sum);
}

